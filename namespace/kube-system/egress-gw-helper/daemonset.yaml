apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: egress-gw-helper
  namespace: kube-system
  labels:
    app.kubernetes.io/name: egress-gw-helper
    app.kubernetes.io/managed-by: flux
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: egress-gw-helper
      app.kubernetes.io/managed-by: flux
  template:
    metadata:
      labels:
        app.kubernetes.io/name: egress-gw-helper
        app.kubernetes.io/managed-by: flux
    spec:
      hostNetwork: true
      hostPID: true
      containers:
        - name: egress-gw-helper
        # renovate: datasource=docker depName=docker.io/alpine
          image: docker.io/alpine:edge@sha256:115729ec5cb049ba6359c3ab005ac742012d92bbaa5b8bc1a878f1e8f62c0cb8
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache iproute2
              ip rule add from 10.72.127.202/32 table 100 priority 100 2>/dev/null || true
              ip route add 10.64.0.1/32 dev wg0 table 100              2>/dev/null || true
              ip route add default dev wg0 table 100                   2>/dev/null || true
              sleep infinity
      tolerations:
        - operator: Exists