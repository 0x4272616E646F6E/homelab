apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-config-map
  namespace: authentik
data:
  values.yaml: |-
    image:
      tag: "2025.8.1"
      pullPolicy: IfNotPresent
    
    authentik:
      secret_key:
        valueFrom:
          secretKeyRef:
            name: authentik-secrets
            key: SECRET_KEY
      error_reporting:
        enabled: false
      # Configure Authentik to use our external PostgreSQL
      postgresql:
        host: authentik-postgres-15
        user: authentik
        password:
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: POSTGRES_PASSWORD
        name: authentik
    
    server:
      ingress:
        ingressClassName: envoy
        enabled: false
        hosts:
          - authentik.oglesby.io

    # Disable the built-in PostgreSQL
    postgresql:
      enabled: false

    redis:
      enabled: true
      architecture: standalone
      master:
        persistence:
          enabled: false
        resources:
          requests:
            memory: 256Mi
          limits:
            memory: 512Mi
        extraFlags:
          - --save
          - ""
          - --appendonly
          - "no"
          
    # Tell Flux to force re-deploy to pick up value changes  
    postRenderers:
      - kustomize:
          patches:
            - target:
                kind: StatefulSet
                name: authentik-postgresql
              patch: |
                - op: replace
                  path: /spec/template/spec/containers/0/image
                  value: docker.io/postgres:15.8-bookworm