{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    ":semanticCommits",
    ":semanticCommitTypeAll(chore)"
  ],
  "dependencyDashboard": true,
  "prHourlyLimit": 6,
  "prConcurrentLimit": 10,
  "rangeStrategy": "replace",
  "rebaseWhen": "behind-base-branch",
  "ignorePaths": [
    "k8s/clusters/**/flux-system/**"
  ],
  "enabledManagers": [
    "kubernetes",
    "helm-values",
    "custom.regex",
    "github-actions"
  ],
  "kubernetes": {
    "managerFilePatterns": [
      "/(^|/)namespaces/.+\\.ya?ml$/",
      "/(^|/)clusters/.+\\.ya?ml$/",
      "/(^|/)talos/.+\\.ya?ml$/"
    ]
  },
  "helm-values": {
    "managerFilePatterns": [
      "/(^|/)values\\.ya?ml$/"
    ]
  },
  "customManagers": [
    {
      "customType": "regex",
      "description": "Bump Flux HelmRelease chart versions (requires a registryUrl comment)",
      "managerFilePatterns": [
        "/(^|/)namespaces/.+\\.ya?ml$/",
        "/(^|/)clusters/.+\\.ya?ml$/"
      ],
      "matchStrings": [
        "#\\s*renovate:\\s*registryUrl=(?<registryUrl>\\S+)[\\s\\S]*?kind:\\s*HelmRelease[\\s\\S]*?chart:[\\s\\S]*?spec:[\\s\\S]*?chart:\\s*(?<depName>[^\\s]+)[\\s\\S]*?version:\\s*(?<currentValue>[^\\s]+)"
      ],
      "datasourceTemplate": "helm",
      "depNameTemplate": "{{depName}}",
      "registryUrlTemplate": "{{registryUrl}}",
      "versioningTemplate": "semver"
    },
    {
      "customType": "regex",
      "description": "Bump image tags inside ConfigMap-embedded values.yaml blocks",
      "managerFilePatterns": [
        "/(^|/)namespaces/.+/configmap\\.ya?ml$/"
      ],
      "matchStrings": [
        "repository:\\s*(?<depName>[-\\w./:]+)\\s*\\n\\s*tag:\\s*(?<currentValue>[^\\s]+)"
      ],
      "datasourceTemplate": "docker",
      "depNameTemplate": "{{depName}}",
      "versioningTemplate": "semver"
    }
  ],
  "packageRules": [
    {
      "description": "Label container image updates",
      "matchManagers": ["kubernetes", "helm-values"],
      "labels": ["deps", "container"]
    },
    {
      "description": "Label Helm chart updates",
      "matchManagers": ["custom.regex"],
      "labels": ["deps", "helm"]
    },
    {
      "description": "Pin and label GitHub Actions",
      "matchManagers": ["github-actions"],
      "pinDigests": true,
      "labels": ["deps", "github-actions"]
    },
    {
      "description": "Pin all container image digests",
      "matchDatasources": ["docker"],
      "pinDigests": true
    },
    {
      "description": "Auto-merge minor, patch, and digest updates",
      "matchUpdateTypes": ["minor", "patch", "digest"],
      "automerge": true
    },
    {
      "description": "Keep Jellyfin on semver tags only",
      "matchDatasources": ["docker"],
      "matchPackageNames": ["lscr.io/linuxserver/jellyfin"],
      "allowedVersions": "/^\\d+\\.\\d+\\.\\d+(?:[-.+].*)?$/"
    },
    {
      "description": "Keep nzbget on versioned+date tags only",
      "matchDatasources": ["docker"],
      "matchPackageNames": ["lscr.io/linuxserver/nzbget"],
      "allowedVersions": "/^\\d+\\.\\d+\\.\\d{8}(?:[-.+].*)?$/"
    },
    {
      "description": "Lock Postgres to 17.x in SonarQube",
      "matchDatasources": ["docker"],
      "matchPackageNames": [
        "postgres",
        "docker.io/postgres",
        "library/postgres",
        "index.docker.io/postgres"
      ],
      "matchFileNames": [
        "k8s/namespaces/development/sonarqube/postgres/statefulset.yaml"
      ],
      "allowedVersions": "/^17\\.6(\\.\\d+.*)?$/"
    }
  ]
}