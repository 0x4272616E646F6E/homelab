name: CI

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write   # allow uploading SARIF to Code Scanning

jobs:
  kube-validate:
    name: Validate Kubernetes Manifests
    runs-on: actions-runner
    steps:
      - uses: actions/checkout@v4
      - name: Install kubeconform
        run: |
          set -euo pipefail
          KUBECONFORM_VERSION=0.6.7
          curl -sL "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz" \
            | sudo tar -xz -C /usr/local/bin kubeconform
          kubeconform -v
      - name: Validate manifests with kubeconform
        run: |
          set -euo pipefail
          mapfile -t FILES < <(git ls-files \
            'namespace/**/*.y*ml' \
            'clusters/**/*.y*ml' \
            'talos/**/*.y*ml' \
            ':!:clusters/**/flux-system/**')
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "No manifests to validate."
          else
            kubeconform -summary -strict -ignore-missing-schemas -kubernetes-version 1.30.0 \
              -schema-location default \
              -schema-location 'https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/{{.NormalizedKubernetesVersion}}-standalone/{{.ResourceKind}}.json' \
              "${FILES[@]}"
          fi

  checkov-k8s:
    name: Checkov
    runs-on: actions-runner
    steps:
      - uses: actions/checkout@v4
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: kubernetes
          skip_path: |
            clusters/**/flux-system
            cdk8s/target
            cdk8s/dist
          output_format: sarif
          output_file_path: checkov-k8s.sarif
      - name: Upload SARIF (Checkov K8s)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-k8s.sarif

  java-build-and-scan:
    name: Build & Scan Java (cdk8s + Trivy)
    runs-on: actions-runner
    defaults:
      run:
        working-directory: cdk/cdk8s
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
      - name: Build (compile only)
        run: mvn -B -q -DskipTests package
      - name: Trivy (fs scan of Java project)
        uses: aquasecurity/trivy-action@0.22.0
        with:
          scan-type: fs
          scan-ref: .              # cdk8s dir due to working-directory
          format: sarif
          output: trivy-java.sarif
          severity: HIGH,CRITICAL
          exit-code: '1'
          ignore-unfixed: true
      - name: Upload SARIF (Trivy Java)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: cdk8s/trivy-java.sarif

  gitleaks:
    name: Secret scan (diff)
    runs-on: actions-runner
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: '--verbose --redact --staged'
