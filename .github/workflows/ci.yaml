name: CI

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write   # allow uploading SARIF to Code Scanning

jobs:
  kube-validate:
    name: Validate Kubernetes Manifests
    runs-on: actions-runner

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Install kubeconform
        run: |
          set -euo pipefail
          # renovate: datasource=github-releases depName=yannh/kubeconform
          KUBECONFORM_VERSION=0.6.7
          curl -sL "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz" \
            | sudo tar -xz -C /usr/local/bin kubeconform
          kubeconform -v

      - name: Validate manifests with kubeconform
        run: |
          set -euo pipefail
          mapfile -t FILES < <(git ls-files \
            'k8s/namespaces/**/*.y*ml' \
            'k8s/clusters/**/*.y*ml' \
            ':!:k8s/clusters/**/flux-system/**')
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "No manifests to validate."
          else
            kubeconform -summary -strict -ignore-missing-schemas -kubernetes-version 1.30.0 \
              -schema-location default \
              -schema-location 'https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/{{.NormalizedKubernetesVersion}}-standalone/{{.ResourceKind}}.json' \
              "${FILES[@]}"
          fi

  gitleaks:
    name: Secret scan (diff)
    runs-on: actions-runner
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: '--verbose --redact --log-opts="origin/main..HEAD"'
