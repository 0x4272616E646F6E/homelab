name: Build

permissions:
  contents: read
  
on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build and analyze
    runs-on: actions-runner

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Install Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y maven

      - name: Build Java modules (maven)
        run: mvn -B -f cdk/cdk8s/pom.xml -DskipTests package

      - uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_SCANNER_OPTS: >
            -Dsonar.java.binaries=cdk8s/target/classes
            -Dsonar.sources=cdk/cdk8s,k8s
            -Dsonar.inclusions=**/*.java,**/*.kt,**/*.yaml,**/*.yml,**/*.json
            -Dsonar.projectKey=${{ github.repository }}