apiVersion: v1
kind: ConfigMap
metadata:
  name: qbittorrent-port-forward-sync
  namespace: media
data:
  qb_port_sync.nu: |
    #!/usr/bin/env nu

    # qBittorrent NAT-PMP Port Forward Sync
    # Refreshes ProtonVPN NAT-PMP port mapping and updates qBittorrent listen port

    def get-forwarded-port [gateway: string, lease: int]: nothing -> int {
        try {
            let result = (^natpmpc -a 1 0 udp $"($lease)" -g $gateway | complete)
            if $result.exit_code != 0 {
                print -e $"[qb-sync] ERROR: natpmpc exited with ($result.exit_code)"
                return 0
            }
            let matches = ($result.stdout | parse --regex 'Mapped public port (?P<port>\d+)')
            if ($matches | is-empty) {
                print -e "[qb-sync] ERROR: no port in natpmpc output"
                return 0
            }
            $matches | first | get port | into int
        } catch {|e|
            print -e $"[qb-sync] ERROR: natpmpc failed: ($e.msg)"
            0
        }
    }

    def qb-login [base: string, user: string, pass: string]: nothing -> string {
        let url = $"($base)/auth/login"
        let resp = (http post --full --content-type "application/x-www-form-urlencoded" $url {username: $user, password: $pass})
        if ($resp.body | str trim) != "Ok." {
            error make {msg: "qB auth failed"}
        }
        let cookies = ($resp.headers | where name == "set-cookie")
        if ($cookies | is-not-empty) {
            $cookies | first | get value
        } else {
            ""
        }
    }

    def qb-set-listen-port [base: string, port: int, cookie: string] {
        let prefs = ({listen_port: $port} | to json)
        let url = $"($base)/app/setPreferences"
        if ($cookie | is-not-empty) {
            http post --content-type "application/x-www-form-urlencoded" --headers [cookie $cookie] $url {json: $prefs} | ignore
        } else {
            http post --content-type "application/x-www-form-urlencoded" $url {json: $prefs} | ignore
        }
    }

    def write-state [path: string, port: int] {
        try {
            mkdir ($path | path dirname)
            $"($port)" | save -f $path
        } catch {|e|
            print -e $"[qb-sync] warn: cannot write state file: ($e.msg)"
        }
    }

    def main [] {
        let gateway = ($env | get -o GATEWAY | default "10.2.0.1")
        let lease = ($env | get -o LEASE | default "60" | into int)
        let refresh = ([10 ($lease - 15)] | math max)
        let qb_host = ($env | get -o QB_HOST | default "127.0.0.1")
        let qb_port = ($env | get -o QB_PORT | default "8080")
        let qb_user = ($env | get -o QB_USER | default "")
        let qb_pass = ($env | get -o QB_PASS | default "")
        let state_file = ($env | get -o STATE_FILE | default "/run/protonvpn-forwarded-port")
        let base = $"http://($qb_host):($qb_port)/api/v2"

        mut cookie = ""
        if ($qb_user | is-not-empty) and ($qb_pass | is-not-empty) {
            try {
                $cookie = (qb-login $base $qb_user $qb_pass)
            } catch {|e|
                print -e $"[qb-sync] ERROR qB login failed: ($e.msg)"
                print -e "[qb-sync] continuing without auth"
            }
        } else {
            print -e "[qb-sync] no QB credentials provided; skipping login"
        }

        print "[qb-sync] started"
        print "[qb-sync] using Cilium egress gateway for routing"

        mut last_port = 0
        loop {
            let port = (get-forwarded-port $gateway $lease)
            if $port > 0 {
                if $port != $last_port {
                    print $"[qb-sync] new forwarded port: ($port)"
                    try {
                        qb-set-listen-port $base $port $cookie
                        write-state $state_file $port
                        $last_port = $port
                        print "[qb-sync] qBittorrent updated OK"
                    } catch {|e|
                        print -e $"[qb-sync] ERROR updating qB: ($e.msg)"
                    }
                } else {
                    print $"[qb-sync] port unchanged: ($port)"
                }
            } else {
                print "[qb-sync] no NAT-PMP reply; will retry"
            }
            sleep ($refresh * 1sec)
        }
    }

    main
