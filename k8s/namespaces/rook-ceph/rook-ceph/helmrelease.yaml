# renovate: registryUrl=https://charts.rook.io/release
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: rook-ceph
  namespace: rook-ceph
spec:
  chart:
    spec:
      chart: rook-ceph
      version: 1.18.2
      sourceRef:
        kind: HelmRepository
        name: rook-release
        namespace: flux-system
  interval: 15m
  timeout: 5m
  releaseName: rook-ceph
  valuesFrom:
  - kind: ConfigMap
    name: rook-ceph-config-map
    valuesKey: values.yaml
  postRenderers:
  - kustomize:
      patches:
      - target:
          kind: Deployment
          labelSelector: app=rook-ceph-osd
        patch: |-
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: rook-ceph-osd
            namespace: rook-ceph
          spec:
            template:
              spec:
                containers:
                - name: osd
                  securityContext:
                    capabilities:
                      drop: []
                    privileged: true
                    runAsUser: 0
                initContainers:
                - name: cephx-keyring-update
                  securityContext:
                    capabilities:
                      drop: []
                    privileged: true
                    runAsUser: 0
                - name: chown-container-data-dir
                  securityContext:
                    capabilities:
                      drop: []
                    privileged: true
                    runAsUser: 0
                - name: activate
                  securityContext:
                    capabilities:
                      drop: []
                    privileged: true
                    runAsUser: 0
                - name: expand-bluefs
                  securityContext:
                    capabilities:
                      drop: []
                    privileged: true
                    runAsUser: 0
      - target:
          kind: Deployment
          labelSelector: app=rook-ceph-mgr
        patch: |-
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: rook-ceph-mgr
            namespace: rook-ceph
          spec:
            template:
              spec:
                containers:
                - name: mgr
                  securityContext:
                    capabilities:
                      drop: []
                    privileged: true
                    runAsUser: 0
                initContainers:
                - name: chown-container-data-dir
                  securityContext:
                    capabilities:
                      drop: []
                    privileged: true
                    runAsUser: 0