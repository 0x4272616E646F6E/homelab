apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-config-map
  namespace: monitoring
data:
  values.yaml: |-
    deploymentMode: SingleBinary

    loki:
      auth_enabled: false
      commonConfig:
        replication_factor: 1
      memberlist:
        join_members: []
      schemaConfig:
        configs:
          - from: 2024-04-01
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: loki_index_
              period: 24h
      storage:
        type: filesystem
        filesystem:
          chunks_directory: /var/loki/chunks
          rules_directory: /var/loki/rules
      compactor:
        working_directory: /var/loki/compactor
        retention_enabled: true
        delete_request_store: filesystem
      limits_config:
        retention_period: 168h
        ingestion_rate_mb: 16
        ingestion_burst_size_mb: 32
        volume_enabled: true
      ruler:
        alertmanager_url: http://prometheus-kube-prometheus-alertmanager.monitoring.svc.cluster.local:9093

    # Disable all distributed components
    write:
      replicas: 0
    read:
      replicas: 0
    backend:
      replicas: 0
    
    # Disable gateway (not needed for SingleBinary)
    gateway:
      enabled: false
    
    # Disable caching (not needed for SingleBinary)
    chunksCache:
      enabled: false
    resultsCache:
      enabled: false
    
    singleBinary:
      enabled: true
      replicas: 1
      persistence:
        enabled: true
        size: 50Gi
        storageClass: local-path-rwo
      resources:
        requests:
          cpu: 300m
          memory: 512Mi
        limits:
          cpu: 1500m
          memory: 2Gi
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3100"
      extraArgs:
        - -config.expand-env=true
      service:
        ports:
          - name: http-metrics
            port: 3100
            targetPort: http-metrics

    monitoring:
      selfMonitoring:
        enabled: false
      serviceMonitor:
        enabled: true
        interval: 30s
        additionalLabels: 
    lokiCanary:
      enabled: false
