apiVersion: batch/v1
kind: CronJob
metadata:
  name: clamav-scanner
  namespace: security
  labels:
    app.kubernetes.io/name: clamav
    app.kubernetes.io/component: scanner
    app.kubernetes.io/managed-by: flux
spec:
  schedule: "0 1 * * 0"  # Every Sunday at 1 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        metadata:
          labels:
            app.kubernetes.io/name: clamav
            app.kubernetes.io/component: scanner
        spec:
          automountServiceAccountToken: false
          restartPolicy: Never
          containers:
            - name: scanner
              # renovate: datasource=docker depName=clamav/clamav
              image: docker.io/clamav/clamav:1.5@sha256:994903183e3bfda6a9fd7d39e773b33054c16b8dd15aa6d3e4aba0405f893a3a
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - /scripts/scan-script.sh
              env:
                - name: CLAMD_HOST
                  value: "clamav.security.svc.cluster.local"
                - name: CLAMD_PORT
                  value: "3310"
                - name: SCAN_PATHS
                  value: "/data/storage"
              volumeMounts:
                - name: local-path-data
                  mountPath: /data/storage
                  readOnly: true
                - name: quarantine
                  mountPath: /quarantine
                - name: scripts
                  mountPath: /scripts
              resources:
                requests:
                  cpu: "500m"
                  memory: "512Mi"
                limits:
                  cpu: "2000m"
                  memory: "1Gi"
              securityContext:
                allowPrivilegeEscalation: true
                readOnlyRootFilesystem: false
                privileged: true
                runAsNonRoot: false
                runAsUser: 0
                capabilities:
                  add:
                    - DAC_READ_SEARCH
          volumes:
            - name: local-path-data
              hostPath:
                path: /var/mnt/storage/local-path-provisioner
                type: Directory
            - name: quarantine
              persistentVolumeClaim:
                claimName: clamav-quarantine
            - name: scripts
              configMap:
                name: clamav-config
                defaultMode: 0755
                items:
                  - key: scan-script.sh
                    path: scan-script.sh
