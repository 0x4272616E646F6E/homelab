apiVersion: v1
kind: ConfigMap
metadata:
  name: local-path-provisioner-config-map
  namespace: kube-system
data:
  values.yaml: |-
    image:
      repository: rancher/local-path-provisioner
      tag: v0.0.32
      pullPolicy: IfNotPresent

    helperImage:
      repository: busybox
      tag: "1.36.1"

    # Disable the single default SC. define both classes below
    storageClass:
      create: false

    # Where volumes live on the node
    nodePathMap:
      - node: DEFAULT_PATH_FOR_NON_LISTED_NODES
        paths:
          - /var/mnt/storage/local-path-provisioner

    storageClassConfigs:
      local-path-rwo:
        storageClass:
          create: true
          name: local-path-rwo
          defaultClass: true
          defaultVolumeType: hostPath
          reclaimPolicy: Retain
          volumeBindingMode: WaitForFirstConsumer
          allowVolumeExpansion: true
        nodePathMap:
          - node: DEFAULT_PATH_FOR_NON_LISTED_NODES
            paths:
              - /var/mnt/storage/local-path-provisioner

      local-path-rwx:
        storageClass:
          create: true
          name: local-path-rwx
          defaultClass: false
          defaultVolumeType: hostPath
          reclaimPolicy: Retain
          volumeBindingMode: WaitForFirstConsumer
          allowVolumeExpansion: true
        nodePathMap:
          - node: DEFAULT_PATH_FOR_NON_LISTED_NODES
            paths:
              - /var/mnt/storage/local-path-provisioner
        # Switch to a real shared FS
        # sharedFileSystemPath: /srv/nfs/rwx
        # nodePathMap: []

    # Talos control-plane taint tolerance (single-node)
    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"
      - key: "node-role.kubernetes.io/master"
        operator: "Exists"
        effect: "NoSchedule"

    podSecurityContext: {}

    # setup/teardown scripts ConfigMap used by the controller
    configmap:
      name: local-path-config
      setup: |-
        #!/bin/sh
        set -eu
        mkdir -m 0777 -p "$VOL_DIR"
      teardown: |-
        #!/bin/sh
        set -eu
        rm -rf "$VOL_DIR"
      helperPod:
        name: "helper-pod"
        namespaceOverride: ""
        annotations: {}
        tolerations: []