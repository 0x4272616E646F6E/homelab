apiVersion: apps/v1
kind: Deployment
metadata:
  name: open-webui
  namespace: development
  labels:
    app.kubernetes.io/name: open-webui
    app.kubernetes.io/managed-by: flux
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: open-webui
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate: { maxSurge: 0, maxUnavailable: 1 }
  template:
    metadata:
      labels:
        app.kubernetes.io/name: open-webui
        app.kubernetes.io/managed-by: flux
    spec:
      automountServiceAccountToken: false
      containers:
      - name: open-webui
        # renovate: datasource=docker depName=ghcr.io/open-webui/open-webui
        image: ghcr.io/open-webui/open-webui:main@sha256:ea750f19fc2a7ca0cb221bc512b8c2c470a01616b89ed98cb77d9ab0d5f24109
        imagePullPolicy: IfNotPresent
        env:
        - name: WEBUI_SECRET_KEY
          valueFrom: { secretKeyRef: { name: open-webui-secrets, key: WEBUI_SECRET_KEY } }
        - { name: WEBUI_AUTH,           value: "true" }
        - { name: OPENAI_API_BASE_URLS, value: "http://llamacpp-model:8000/v1" }
        - { name: OPENAI_API_KEYS,      value: "llamacpp" }
        - { name: ENABLE_OLLAMA_API,    value: "false" }
        - { name: ENABLE_AUTOCOMPLETE_GENERATION, value: "false" }
        - { name: ENABLE_TAGS_GENERATION,          value: "false" }
        - { name: ENABLE_SEARCH_QUERY_GENERATION,  value: "false" }
        - { name: ENABLE_TITLE_GENERATION,     value: "false" }
        - { name: AIOHTTP_CLIENT_TIMEOUT,     value: "300" }
        ports:
        - { containerPort: 8080, name: http }
        resources:
          requests: { cpu: "500m", memory: "512Mi" }
          limits:   { cpu: "2",    memory: "2Gi" }
        securityContext:
          runAsUser: 1000
          allowPrivilegeEscalation: false
          capabilities: { drop: ["ALL"] }
        volumeMounts:
        - { name: data, mountPath: /app/backend/data }
        readinessProbe:
          httpGet: { path: /health, port: http }
          initialDelaySeconds: 10
          periodSeconds: 10
          failureThreshold: 30
        startupProbe:
          httpGet: { path: /health, port: http }
          periodSeconds: 15
          failureThreshold: 60
      volumes:
      - name: data
        persistentVolumeClaim: { claimName: open-webui-pvc }
