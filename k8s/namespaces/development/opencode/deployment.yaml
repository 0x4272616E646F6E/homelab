apiVersion: apps/v1
kind: Deployment
metadata:
  name: opencode
  namespace: development
  labels:
    app.kubernetes.io/name: opencode
    app.kubernetes.io/managed-by: flux
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: opencode
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate: { maxSurge: 0, maxUnavailable: 1 }
  template:
    metadata:
      labels:
        app.kubernetes.io/name: opencode
        app.kubernetes.io/managed-by: flux
    spec:
      terminationGracePeriodSeconds: 30
      automountServiceAccountToken: false
      initContainers:
      - name: install-tools
        # renovate: datasource=docker depName=mcr.microsoft.com/devcontainers/universal
        image: mcr.microsoft.com/devcontainers/universal:latest
        command: ["bash", "-c"]
        args:
          - |
            # OpenCode
            if [ ! -f /root/.opencode/bin/opencode ]; then
              echo "Installing opencode..."
              curl -fsSL https://opencode.ai/install | bash
            else
              echo "opencode already installed, skipping."
            fi

            # Rust
            if [ ! -f /root/.cargo/bin/rustc ]; then
              echo "Installing Rust..."
              curl -fsSL https://sh.rustup.rs | bash -s -- -y
            else
              echo "Rust already installed, skipping."
            fi

            # Swift
            if [ ! -f /root/.local/swift/usr/bin/swift ]; then
              echo "Installing Swift..."
              SWIFT_URL=$(curl -fsSL https://www.swift.org/api/v1/install/dev/ubuntu/2404/aarch64,x86_64 2>/dev/null | grep -oP '"url"\s*:\s*"\K[^"]+x86_64[^"]+' | head -1)
              if [ -z "$SWIFT_URL" ]; then
                SWIFT_URL="https://download.swift.org/swift-6.1.2-release/ubuntu2404/swift-6.1.2-RELEASE/swift-6.1.2-RELEASE-ubuntu24.04.tar.gz"
              fi
              mkdir -p /root/.local/swift
              curl -fsSL "$SWIFT_URL" | tar xz --strip-components=1 -C /root/.local/swift
            else
              echo "Swift already installed, skipping."
            fi

            # uv (Python package manager)
            if [ ! -f /root/.local/bin/uv ]; then
              echo "Installing uv..."
              curl -fsSL https://astral.sh/uv/install.sh | bash
            else
              echo "uv already installed, skipping."
            fi

            # Bun
            if [ ! -f /root/.bun/bin/bun ]; then
              echo "Installing Bun..."
              curl -fsSL https://bun.sh/install | bash
            else
              echo "Bun already installed, skipping."
            fi

            # Nushell
            if [ ! -f /root/.local/bin/nu ]; then
              echo "Installing Nushell..."
              NU_VER=$(curl -fsSL https://api.github.com/repos/nushell/nushell/releases/latest | grep -oP '"tag_name":\s*"\K[^"]+')
              mkdir -p /root/.local/bin
              curl -fsSL "https://github.com/nushell/nushell/releases/download/${NU_VER}/nu-${NU_VER}-x86_64-unknown-linux-gnu.tar.gz" \
                | tar xz --strip-components=1 -C /root/.local/bin
            else
              echo "Nushell already installed, skipping."
            fi
        volumeMounts:
        - { name: home, mountPath: /root }
      containers:
      - name: ttyd
        # renovate: datasource=docker depName=mcr.microsoft.com/devcontainers/universal
        image: mcr.microsoft.com/devcontainers/universal:latest
        command: ["bash", "-c"]
        args:
          - |
            curl -fsSL https://github.com/tsl0922/ttyd/releases/latest/download/ttyd.x86_64 -o /usr/local/bin/ttyd && \
            chmod +x /usr/local/bin/ttyd && \
            export PATH="/root/.opencode/bin:/root/.cargo/bin:/root/.local/swift/usr/bin:/root/.local/bin:/root/.bun/bin:$PATH" && \
            exec ttyd --writable bash
        ports:
        - { containerPort: 7681, name: http }
        resources:
          requests: { cpu: "100m", memory: "256Mi", ephemeral-storage: "1Gi" }
          limits:   { cpu: "2",    memory: "4Gi",   ephemeral-storage: "5Gi" }
        volumeMounts:
        - { name: home, mountPath: /root }
      volumes:
      - name: home
        persistentVolumeClaim: { claimName: opencode-home }
