---
- name: Configure Proxmox Host Baseline
  hosts: proxmox
  become: true
  gather_facts: true

  tasks:
    - name: Set timezone
      community.general.timezone:
        name: "{{ timezone }}"
      notify: Restart systemd-timesyncd

    - name: Configure DNS servers in resolv.conf
      ansible.builtin.template:
        src: templates/network/resolv.conf.j2
        dest: /etc/resolv.conf
        owner: root
        group: root
        mode: '0644'
      when: (dns_servers | default([])) | length > 0

    - name: Install chrony for NTP
      ansible.builtin.apt:
        name: chrony
        state: present
        update_cache: true

    - name: Configure chrony NTP servers
      ansible.builtin.template:
        src: templates/timesync/chrony.conf.j2
        dest: /etc/chrony/chrony.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart chrony

    - name: Enable and start chrony service
      ansible.builtin.systemd:
        name: chrony
        enabled: true
        state: started

    - name: Configure rsyslog for remote logging
      ansible.builtin.template:
        src: templates/logging/rsyslog-remote.conf.j2
        dest: /etc/rsyslog.d/50-remote.conf
        owner: root
        group: root
        mode: '0644'
      when: syslog_enabled and syslog_server != ''
      notify: Restart rsyslog

    - name: Configure ACME certificates for Proxmox API
      when: acme_enabled
      block:
        - name: Ensure ACME domain list is defined
          ansible.builtin.assert:
            that:
              - (acme_domains | default([])) | length > 0
            fail_msg: "ACME is enabled but no domains were defined."

        - name: Initialize normalized ACME domain list
          ansible.builtin.set_fact:
            _acme_domains_normalized: []

        - name: Normalize ACME domain definitions
          vars:
            normalized_domain_map:
              domain: "{{ item.domain if item is mapping else item }}"
              alias: "{{ item.alias if (item is mapping and ('alias' in item)) else '' }}"
              plugin: "{{ item.plugin if (item is mapping and ('plugin' in item)) else acme_plugin_name }}"
          ansible.builtin.set_fact:
            _acme_domains_normalized: "{{ _acme_domains_normalized + [normalized_domain_map] }}"
          loop: "{{ acme_domains }}"
          loop_control:
            label: "{{ item.domain if (item is mapping) else item }}"

        - name: Build ACME domain string
          ansible.builtin.set_fact:
            _acme_domain_string: "{{ _acme_domains_normalized | map(attribute='domain') | join(';') }}"

        - name: Record Proxmox node name for ACME operations
          ansible.builtin.set_fact:
            _acme_node_name: "{{ ansible_nodename | default(inventory_hostname) }}"

        - name: Retrieve ACME metadata (ToS)
          ansible.builtin.command:
            argv:
              - pvesh
              - get
              - /cluster/acme/meta
              - --directory
              - "{{ acme_directory_url }}"
              - --output-format
              - json
          register: _acme_meta_raw
          changed_when: false

        - name: Parse ACME metadata response
          ansible.builtin.set_fact:
            _acme_meta: "{{ _acme_meta_raw.stdout | default('{}', true) | from_json }}"

        - name: List existing ACME accounts
          ansible.builtin.command:
            argv:
              - pvesh
              - get
              - /cluster/acme/account
              - --output-format
              - json
          register: _acme_accounts_raw
          changed_when: false

        - name: Cache ACME account names
          ansible.builtin.set_fact:
            _acme_account_names: "{{ _acme_accounts_raw.stdout | default('[]', true) | from_json | map(attribute='name') | list }}"

        - name: Register ACME account if missing
          ansible.builtin.command: "{{ [
              'pvesh create /cluster/acme/account',
              '--name ' ~ (acme_account_name | quote),
              '--contact ' ~ (acme_account_email | quote),
              '--directory ' ~ (acme_directory_url | quote),
              ('--tos_url ' ~ (_acme_meta.termsOfService | quote)) if (_acme_meta.termsOfService | default('')) | length > 0 else ''
            ] | reject('equalto', '') | join(' ') }}"
          when: acme_account_name not in _acme_account_names
          changed_when: true

        - name: Ensure ACME DNS plugin configuration is valid
          ansible.builtin.assert:
            that:
              - acme_plugin_api | length > 0
            fail_msg: "acme_plugin_api must be set when acme_plugin_type is 'dns'."
          when: acme_plugin_type == 'dns'

        - name: Build ACME plugin node list string
          ansible.builtin.set_fact:
            _acme_plugin_nodes_str: "{{ acme_plugin_nodes | join(',') }}"
          when: acme_plugin_type == 'dns'

        - name: List existing ACME plugins
          ansible.builtin.command:
            argv:
              - pvesh
              - get
              - /cluster/acme/plugins
              - --output-format
              - json
          register: _acme_plugins_raw
          changed_when: false
          when: acme_plugin_type == 'dns'

        - name: Cache ACME plugin identifiers
          ansible.builtin.set_fact:
            _acme_plugin_names: "{{ _acme_plugins_raw.stdout | default('[]', true) | from_json | map(attribute='plugin') | list }}"
          when: acme_plugin_type == 'dns'

        - name: Create ACME DNS plugin when missing
          ansible.builtin.command: "{{ [
              'pvesh create /cluster/acme/plugins',
              '--id ' ~ (acme_plugin_name | quote),
              '--type dns',
              '--api ' ~ (acme_plugin_api | quote),
              '--validation-delay ' ~ (acme_plugin_validation_delay | string),
              ('--nodes ' ~ (_acme_plugin_nodes_str | quote)) if (_acme_plugin_nodes_str | default('')) | length > 0 else '',
              ('--data ' ~ (acme_plugin_data_b64 | quote)) if (acme_plugin_data_b64 | length) > 0 else ''
            ] | reject('equalto', '') | join(' ') }}"
          when:
            - acme_plugin_type == 'dns'
            - acme_plugin_name not in _acme_plugin_names
          changed_when: true

        - name: Read ACME plugin details
          ansible.builtin.command:
            argv:
              - pvesh
              - get
              - "/cluster/acme/plugins/{{ acme_plugin_name }}"
              - --output-format
              - json
          register: _acme_plugin_info_raw
          changed_when: false
          when:
            - acme_plugin_type == 'dns'
            - acme_plugin_name in _acme_plugin_names

        - name: Parse ACME plugin details
          ansible.builtin.set_fact:
            _acme_plugin_current: "{{ _acme_plugin_info_raw.stdout | default('{}') | from_json }}"
          when:
            - acme_plugin_type == 'dns'
            - acme_plugin_name in _acme_plugin_names

        - name: Update ACME DNS plugin options when changed
          ansible.builtin.command: "{{ [
              'pvesh set /cluster/acme/plugins/' ~ acme_plugin_name,
              '--api ' ~ (acme_plugin_api | quote),
              '--validation-delay ' ~ (acme_plugin_validation_delay | string),
              ('--nodes ' ~ (_acme_plugin_nodes_str | quote)) if (_acme_plugin_nodes_str | default('')) | length > 0 else '',
              ('--data ' ~ (acme_plugin_data_b64 | quote)) if (acme_plugin_data_b64 | length) > 0 else ''
            ] | reject('equalto', '') | join(' ') }}"
          when:
            - acme_plugin_type == 'dns'
            - acme_plugin_name in _acme_plugin_names
            - (
                (_acme_plugin_current.api | default('')) != acme_plugin_api
                or ((_acme_plugin_current['validation-delay'] | default(0)) | int) != (acme_plugin_validation_delay | int)
                or ((_acme_plugin_current.nodes | default('')) != (_acme_plugin_nodes_str | default('')))
              )
          changed_when: true

        - name: Fetch existing node ACME configuration
          ansible.builtin.command:
            argv:
              - pvesh
              - get
              - "/nodes/{{ _acme_node_name }}/config"
              - --output-format
              - json
          register: _acme_node_config_raw
          changed_when: false

        - name: Parse node ACME configuration
          ansible.builtin.set_fact:
            _acme_node_config: "{{ _acme_node_config_raw.stdout | default('{}', true) | from_json }}"

        - name: Determine ACME domain keys to remove
          ansible.builtin.set_fact:
            _acme_domain_keys_to_remove: "{{ _acme_node_config | dict2items | selectattr('key', 'match', '^acmedomain') | map(attribute='key') | list }}"

        - name: Remove previously defined ACME domain entries
          ansible.builtin.command:
            argv:
              - pvesh
              - set
              - "/nodes/{{ _acme_node_name }}/config"
              - --delete
              - "{{ _acme_domain_keys_to_remove | join(',') }}"
          when: (_acme_domain_keys_to_remove | length) > 0
          changed_when: true

        - name: Configure node-wide ACME defaults
          ansible.builtin.command:
            argv:
              - pvesh
              - set
              - "/nodes/{{ _acme_node_name }}/config"
              - --acme
              - "account={{ acme_account_name }}{{ (',domains=' ~ _acme_domain_string) if (_acme_domain_string | length) > 0 else '' }}"
          changed_when: true

        - name: Configure ACME domain-specific plugins
          ansible.builtin.command:
            argv:
              - pvesh
              - set
              - "/nodes/{{ _acme_node_name }}/config"
              - "--acmedomain{{ acme_domain_index }}"
              - >-
                {{ 'domain=' ~ acme_domain.domain
                   ~ (',plugin=' ~ acme_domain.plugin if (acme_domain.plugin | length) > 0 else '')
                   ~ (',alias=' ~ acme_domain.alias if (acme_domain.alias | length) > 0 else '') }}
          loop: "{{ _acme_domains_normalized }}"
          loop_control:
            loop_var: acme_domain
            index_var: acme_domain_index
            label: "{{ acme_domain.domain }}"
          changed_when: true

        - name: Order/renew ACME certificate for node
          ansible.builtin.command: "{{ [
              'pvesh set /nodes/' ~ _acme_node_name ~ '/certificates/acme/certificate',
              '--force 1' if acme_force_renew else ''
            ] | reject('equalto', '') | join(' ') }}"
          when: not ansible_check_mode
          changed_when: true

    - name: Initialize kernel command line parameter list
      ansible.builtin.set_fact:
        _kernel_cmdline_params: []
      when: _kernel_cmdline_params is not defined

    - name: Install NUT packages
      ansible.builtin.apt:
        name:
          - nut
          - nut-client
        state: present
      when: nut_enabled

    - name: Gather service facts for NUT
      ansible.builtin.service_facts:
      when: nut_enabled

    - name: Determine NUT client service unit
      ansible.builtin.set_fact:
        _nut_client_service_unit: >-
          {{
            'nut-monitor'
            if 'nut-monitor.service' in (ansible_facts.services | default({}))
            else (
              'nut-client'
              if 'nut-client.service' in (ansible_facts.services | default({}))
              else 'nut-client'
            )
          }}
      when: nut_enabled

    - name: Configure NUT mode
      ansible.builtin.lineinfile:
        path: /etc/nut/nut.conf
        regexp: '^MODE='
        line: 'MODE={{ nut_mode }}'
        create: true
        owner: root
        group: nut
        mode: '0640'
      when: nut_enabled
      notify: Restart nut-client

    - name: Configure NUT upsmon for netclient mode
      ansible.builtin.template:
        src: templates/nut/upsmon.conf.j2
        dest: /etc/nut/upsmon.conf
        owner: root
        group: nut
        mode: '0640'
      when: nut_enabled and nut_mode == 'netclient'
      notify: Restart nut-client

    - name: Configure NUT ups.conf for standalone/netserver mode
      ansible.builtin.template:
        src: templates/nut/ups.conf.j2
        dest: /etc/nut/ups.conf
        owner: root
        group: nut
        mode: '0640'
      when: nut_enabled and nut_mode in ['standalone', 'netserver']
      notify:
        - Restart nut-server
        - Restart nut-client

    - name: Configure NUT upsd.conf for netserver mode
      ansible.builtin.template:
        src: templates/nut/upsd.conf.j2
        dest: /etc/nut/upsd.conf
        owner: root
        group: nut
        mode: '0640'
      when: nut_enabled and nut_mode == 'netserver'
      notify: Restart nut-server

    - name: Configure NUT users for netserver mode
      ansible.builtin.template:
        src: templates/nut/upsd.users.j2
        dest: /etc/nut/upsd.users
        owner: root
        group: nut
        mode: '0640'
      when: nut_enabled and nut_mode == 'netserver'
      notify: Restart nut-server

    - name: Enable and start NUT client service
      ansible.builtin.systemd:
        name: "{{ _nut_client_service_unit | default('nut-monitor') }}"
        enabled: true
        state: started
      when:
        - nut_enabled
        - not ansible_check_mode or (( (_nut_client_service_unit | default('nut-monitor')) ~ '.service') in (ansible_facts.services | default({})) )

    - name: Enable NUT server service (netserver mode)
      ansible.builtin.systemd:
        name: nut-server
        enabled: true
        state: started
      when: nut_enabled and nut_mode == 'netserver'

    - name: Disable enterprise repository warning
      ansible.builtin.replace:
        path: /etc/apt/sources.list.d/pve-enterprise.list
        regexp: '^deb'
        replace: '#deb'
      failed_when: false

    - name: Add Proxmox no-subscription repository
      ansible.builtin.apt_repository:
        repo: "deb http://download.proxmox.com/debian/pve {{ ansible_distribution_release }} pve-no-subscription"
        state: present
        filename: pve-no-subscription
      when: ansible_distribution == 'Debian'

    - name: Install unattended-upgrades package
      ansible.builtin.apt:
        name:
          - unattended-upgrades
          - apt-listchanges
        state: present

    - name: Configure unattended-upgrades periodic updates
      ansible.builtin.template:
        src: templates/unattended-upgrades/20auto-upgrades.j2
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        owner: root
        group: root
        mode: '0644'
      when: unattended_upgrades_enabled

    - name: Configure unattended-upgrades settings
      ansible.builtin.template:
        src: templates/unattended-upgrades/50unattended-upgrades.j2
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        owner: root
        group: root
        mode: '0644'
      when: unattended_upgrades_enabled

    - name: Configure GPU passthrough blacklist
      ansible.builtin.template:
        src: templates/pve-blacklist.conf.j2
        dest: /etc/modprobe.d/pve-blacklist.conf
        owner: root
        group: root
        mode: '0644'
      when: gpu_passthrough_enabled
      notify: Update initramfs

    - name: Ensure apt sources include non-free-firmware for Proxmox
      when: apt_include_non_free_firmware
      block:
        - name: Read pve sources file (if exists)
          ansible.builtin.slurp:
            src: /etc/apt/sources.list.d/pve-no-subscription.list
          register: _pve_sources
          failed_when: false

        - name: Add non-free-firmware to pve-no-subscription repo line if missing
          ansible.builtin.replace:
            path: /etc/apt/sources.list.d/pve-no-subscription.list
            regexp: "(deb .* pve-no-subscription)"
            replace: '\\1 non-free-firmware'
          when: _pve_sources is defined and _pve_sources.content is defined

        - name: Apt-get update after changing repo
          ansible.builtin.apt:
            update_cache: true

    - name: Deploy audit rules for Proxmox config
      when: audit_pve_rules_enabled or auditd_hardening_enabled
      block:
        - name: Create audit rules file for /etc/pve
          ansible.builtin.template:
            src: templates/audit/90-pve.rules.j2
            dest: "{{ audit_pve_rules_path }}"
            owner: root
            group: root
            mode: '0644'
          when: audit_pve_rules_enabled

        - name: Deploy audit hardening rules
          ansible.builtin.template:
            src: templates/audit/99-hardening.rules.j2
            dest: /etc/audit/rules.d/99-hardening.rules
            owner: root
            group: root
            mode: '0644'
          when: auditd_hardening_enabled

        - name: Load audit rules via augenrules if available
          ansible.builtin.command: augenrules --load
          register: _augen
          failed_when: false
          changed_when: false

        - name: Fallback - rebuild /etc/audit/audit.rules from rules.d
          ansible.builtin.command: /sbin/augenrules --load
          register: _augen_fallback
          failed_when: false
          changed_when: false

        - name: Restart auditd to apply rules
          ansible.builtin.systemd:
            name: auditd
            state: restarted
          register: _auditd_restart
          failed_when: false
          changed_when: _auditd_restart is defined and _auditd_restart.state is defined and _auditd_restart.state == 'restarted'

        - name: Verify audit rule present
          ansible.builtin.command: auditctl -l | grep pve-config
          register: _audit_verify
          failed_when: false
          changed_when: false
          when: audit_pve_rules_enabled

    - name: Remove audit hardening rules when disabled
      ansible.builtin.file:
        path: /etc/audit/rules.d/99-hardening.rules
        state: absent
      when: not auditd_hardening_enabled

    - name: Install and configure pve_exporter for Prometheus
      when: pve_exporter_enabled
      block:
        - name: Try to install pve-exporter package from apt
          ansible.builtin.apt:
            name: pve-exporter
            state: present
          register: _pve_exporter_pkg
          failed_when: false

        - name: Download pve_exporter binary if package not available
          ansible.builtin.get_url:
            url: "https://github.com/prometheus-community/pve_exporter/releases/{{ pve_exporter_version }}/download/pve_exporter-linux-amd64"
            dest: /usr/local/bin/pve_exporter
            mode: '0755'
          when: _pve_exporter_pkg is defined and _pve_exporter_pkg.failed

        - name: Deploy pve_exporter systemd unit
          ansible.builtin.template:
            src: templates/pve_exporter/pve_exporter.service.j2
            dest: /etc/systemd/system/pve_exporter.service
            owner: root
            group: root
            mode: '0644'

        - name: Reload systemd and enable pve_exporter
          ansible.builtin.systemd:
            daemon_reload: true
            name: pve_exporter
            enabled: true
            state: started
          register: _pve_exporter_systemd
          failed_when: false
          changed_when: _pve_exporter_systemd is defined and (_pve_exporter_systemd.state | default('')) == 'started'


    - name: Install and configure Fail2Ban
      when: fail2ban_enabled
      block:
        - name: Install fail2ban
          ansible.builtin.apt:
            name: fail2ban
            state: present

        - name: Deploy fail2ban jail.local
          ansible.builtin.template:
            src: templates/fail2ban/jail.local.j2
            dest: /etc/fail2ban/jail.local
            owner: root
            group: root
            mode: '0644'
          notify: Restart fail2ban

        - name: Deploy Fail2Ban proxmox filter
          ansible.builtin.template:
            src: templates/fail2ban/filter.d/proxmox.conf.j2
            dest: /etc/fail2ban/filter.d/proxmox.conf
            owner: root
            group: root
            mode: '0644'
          notify: Restart fail2ban

        - name: Ensure fail2ban is running
          ansible.builtin.systemd:
            name: fail2ban
            enabled: true
            state: started
          when: not ansible_check_mode
    - name: Install and configure Postfix relay (simple)
      when: smtp_relay_enabled
      block:
        - name: Install postfix
          ansible.builtin.apt:
            name: postfix
            state: present
            update_cache: true

        - name: Deploy Postfix main.cf
          ansible.builtin.template:
            src: templates/postfix/main.cf.j2
            dest: /etc/postfix/main.cf
            owner: root
            group: root
            mode: '0644'

        - name: Deploy sasl_passwd if auth enabled
          ansible.builtin.template:
            src: templates/postfix/sasl_passwd.j2
            dest: /etc/postfix/sasl_passwd
            owner: root
            group: root
            mode: '0600'
          when: smtp_relay_auth and smtp_relay_user != '' and smtp_relay_password != ''

        - name: Postmap sasl_passwd if auth enabled
          ansible.builtin.command: postmap /etc/postfix/sasl_passwd
          when: smtp_relay_auth and smtp_relay_user != '' and smtp_relay_password != ''
          changed_when: false

        - name: Restart postfix
          ansible.builtin.systemd:
            name: postfix
            state: restarted
    - name: Apply ZFS tunables
      when: zfs_tuning_enabled
      block:
        - name: Deploy ZFS tuning file
          ansible.builtin.template:
            src: templates/99-zfs-tuning.conf.j2
            dest: /etc/modprobe.d/99-zfs-tuning.conf
            owner: root
            group: root
            mode: '0644'

        - name: Reload sysctl to apply ZFS tunables
          ansible.builtin.command: sysctl -p /etc/modprobe.d/99-zfs-tuning.conf
          changed_when: false
    - name: Install and configure host ClamAV
      when: host_antivirus_enabled
      block:
        - name: Install clamav packages
          ansible.builtin.apt:
            name:
              - clamav
              - clamav-freshclam
            state: present
            update_cache: true

        - name: Deploy ClamAV host scan cron script
          ansible.builtin.template:
            src: templates/cron/clamav-host-scan.j2
            dest: /etc/cron.daily/clamav-host-scan
            owner: root
            group: root
            mode: '0755'

        - name: Ensure log directory exists for ClamAV host scan
          ansible.builtin.file:
            path: /var/log/clamav
            state: directory
            owner: root
            group: root
            mode: '0755'

    - name: Install and configure rkhunter
      when: rkhunter_enabled
      block:
        - name: Install rkhunter
          ansible.builtin.apt:
            name: rkhunter
            state: present
            update_cache: true

        - name: Deploy rkhunter daily update/scan script
          ansible.builtin.template:
            src: templates/cron/rkhunter-update-scan.j2
            dest: /etc/cron.daily/rkhunter-update-scan
            owner: root
            group: root
            mode: '0755'

    - name: Manage custom logrotate policies
      when: logrotate_custom_enabled
      block:
        - name: Ensure logrotate directory exists
          ansible.builtin.file:
            path: /etc/logrotate.d
            state: directory
            owner: root
            group: root
            mode: '0755'

        - name: Deploy managed logrotate entries
          ansible.builtin.template:
            src: templates/logging/logrotate-entry.j2
            dest: "/etc/logrotate.d/homelab-{{ item.name }}"
            owner: root
            group: root
            mode: '0644'
          loop: "{{ logrotate_configs }}"
          loop_control:
            label: "{{ item.name }}"
          vars:
            logrotate_item: "{{ item }}"
          when: (logrotate_configs | default([])) | length > 0

    - name: Remove managed logrotate configs when disabled
      ansible.builtin.file:
        path: "/etc/logrotate.d/homelab-{{ item.name }}"
        state: absent
      loop: "{{ logrotate_configs }}"
      loop_control:
        label: "{{ item.name }}"
      when:
        - not logrotate_custom_enabled
        - (logrotate_configs | default([])) | length > 0

    - name: Apply sysctl hardening values
      when: sysctl_hardening_enabled
      block:
        - name: Deploy sysctl hardening configuration
          ansible.builtin.template:
            src: templates/sysctl/99-homelab-hardening.conf.j2
            dest: /etc/sysctl.d/99-homelab-hardening.conf
            owner: root
            group: root
            mode: '0644'

        - name: Reload sysctl settings for hardening profile
          ansible.builtin.command: sysctl -p /etc/sysctl.d/99-homelab-hardening.conf
          changed_when: false
          when: not ansible_check_mode

    - name: Remove sysctl hardening file when disabled
      ansible.builtin.file:
        path: /etc/sysctl.d/99-homelab-hardening.conf
        state: absent
      when: not sysctl_hardening_enabled

    - name: Include user-defined kernel parameters
      ansible.builtin.set_fact:
        _kernel_cmdline_params: "{{ (_kernel_cmdline_params | default([])) + (kernel_extra_cmdline_params | default([])) }}"
      when: (kernel_extra_cmdline_params | default([])) | length > 0

    - name: Configure kernel lockdown command line
      when: kernel_lockdown_enabled
      block:
        - name: Append kernel lockdown mode argument
          ansible.builtin.set_fact:
            _kernel_cmdline_params: "{{ (_kernel_cmdline_params | default([])) + ['lockdown=' ~ kernel_lockdown_mode] }}"

        - name: Enforce kernel module signatures when requested
          ansible.builtin.set_fact:
            _kernel_cmdline_params: "{{ (_kernel_cmdline_params | default([])) + ['module.sig_enforce=1'] }}"
          when: kernel_lockdown_sig_enforce

    - name: Determine CPU vendor for IOMMU (if auto)
      ansible.builtin.set_fact:
        _detected_cpu_vendor: >-
          {% if 'Intel' in ansible_facts['processor'] | join(' ') or ansible_facts['vendor_id'] == 'GenuineIntel' %}
          intel
          {% else %}
          amd
          {% endif %}
      when: enable_iommu and iommu_vendor == 'auto'

    - name: Set IOMMU kernel base param for Intel
      ansible.builtin.set_fact:
        _iommu_base: "intel_iommu=on iommu=pt"
      when: enable_iommu and (iommu_vendor == 'intel' or (_detected_cpu_vendor is defined and _detected_cpu_vendor == 'intel'))

    - name: Set IOMMU kernel base param for AMD
      ansible.builtin.set_fact:
        _iommu_base: "amd_iommu=on iommu=pt"
      when: enable_iommu and (iommu_vendor == 'amd' or (iommu_vendor == 'auto' and (_detected_cpu_vendor is defined and _detected_cpu_vendor == 'amd')))

    - name: Build IOMMU kernel param
      ansible.builtin.set_fact:
        _iommu_param: "{{ _iommu_base }} {{ iommu_extra_options }}"
      when:
        - enable_iommu
        - _iommu_base is defined

    - name: Append IOMMU parameters to kernel cmdline
      ansible.builtin.set_fact:
        _kernel_cmdline_params: "{{ (_kernel_cmdline_params | default([])) + [_iommu_param | trim] }}"
      when:
        - enable_iommu
        - _iommu_param is defined

    - name: Build kernel command line string
      ansible.builtin.set_fact:
        _kernel_cmdline_combined: "{{ (_kernel_cmdline_params | default([])) | map('trim') | reject('equalto', '') | list | unique | join(' ') }}"
      when: (_kernel_cmdline_params | default([])) | length > 0

    - name: Ensure GRUB_CMDLINE_LINUX_DEFAULT contains custom parameters
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
        line: "GRUB_CMDLINE_LINUX_DEFAULT=\"quiet{{ ' ' + _kernel_cmdline_combined if (_kernel_cmdline_combined | default('') | length) > 0 else '' }}\""
        backup: true
      when: (_kernel_cmdline_params | default([])) | length > 0
      notify: Update-grub

    - name: Check if Terraform role exists
      ansible.builtin.command: pveum role list
      register: pveum_roles
      changed_when: false

    - name: Create Terraform role if missing
      ansible.builtin.command: pveum role add {{ terraform_prov_role_name }} -privs "{{ terraform_prov_role_privs }}"
      when: terraform_prov_role_name not in (pveum_roles.stdout | default(''))
      changed_when: terraform_prov_role_name not in (pveum_roles.stdout | default(''))

    - name: Check if Terraform user exists
      ansible.builtin.command: pveum user list
      register: pveum_users
      changed_when: false

    - name: Create Terraform user if missing
      ansible.builtin.command: pveum user add {{ terraform_prov_username }} --password '{{ terraform_prov_user_password }}'
      when: terraform_prov_username not in (pveum_users.stdout | default('')) and terraform_prov_user_password != ''
      changed_when: terraform_prov_username not in (pveum_users.stdout | default(''))

    - name: Check ACL for Terraform user at /
      ansible.builtin.command: pveum acl list /
      register: pveum_acls
      changed_when: false
      when: terraform_prov_username != '' and terraform_prov_user_password != ''

    - name: Add ACL for Terraform user at root if missing
      ansible.builtin.command: pveum aclmod / -user {{ terraform_prov_username }} -role {{ terraform_prov_role_name }}
      when:
        - terraform_prov_username != ''
        - terraform_prov_user_password != ''
        - terraform_prov_username not in (pveum_acls.stdout | default(''))
      changed_when: terraform_prov_username not in (pveum_acls.stdout | default(''))

  handlers:
    - name: Restart systemd-timesyncd
      ansible.builtin.systemd:
        name: systemd-timesyncd
        state: restarted

    - name: Restart chrony
      ansible.builtin.systemd:
        name: chrony
        state: restarted

    - name: Restart rsyslog
      ansible.builtin.systemd:
        name: rsyslog
        state: restarted

    - name: Restart nut-server
      ansible.builtin.systemd:
        name: nut-server
        state: restarted
      when:
        - nut_enabled
        - nut_mode == 'netserver'
        - not ansible_check_mode or ('nut-server.service' in (ansible_facts.services | default({})))

    - name: Restart nut-client
      ansible.builtin.systemd:
        name: "{{ _nut_client_service_unit | default('nut-monitor') }}"
        state: restarted
      when:
        - nut_enabled
        - not ansible_check_mode or (( (_nut_client_service_unit | default('nut-monitor')) ~ '.service') in (ansible_facts.services | default({})) )

    - name: Restart fail2ban
      ansible.builtin.systemd:
        name: fail2ban
        state: restarted
      when: not ansible_check_mode

    - name: Update initramfs
      ansible.builtin.command: update-initramfs -u -k all
      when: gpu_passthrough_enabled
      changed_when: false

    - name: Update-grub
      ansible.builtin.command: update-grub
      changed_when: false
